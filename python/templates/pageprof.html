<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plateforme de Gestion Budgétaire - Professeur</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pageprof2.css') }}">
</head>
<body>
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-logo">
                <img src="{{ url_for('static', filename='images/logo_officiel_ESP_UCAD-removebg-preview.png') }}" alt="Logo" class="logo">
            </div>

            <nav>
                <ul>
                    <li class="sidebar-item active" data-section="accueil">
                        <i class="fas fa-home icon"></i>
                        <span>Accueil</span>
                    </li>
                    <li class="sidebar-item" data-section="create-request">
                        <i class="fas fa-file-invoice-dollar icon"></i>
                        <span>Nouvelle demande</span>
                    </li>
                    <li class="sidebar-item" data-section="view-status">
                        <i class="fas fa-list-alt icon"></i>
                        <span>Consulter</span>
                    </li>
                    <li class="sidebar-item" data-section="synthese">
                        <i class="fas fa-chart-bar icon"></i>
                        <span>Synthèse</span>
                    </li>
                </ul>
            </nav>

    <div class="sidebar-item logout-item" data-section="logout">
        <a href="{{ url_for('deconnexion_route') }}" class="menu-link">
            <i class="fas fa-sign-out-alt icon"></i>
            <span>Déconnexion</span>
        </a>
    </div>
</aside>


        <main class="content-area">
            <section id="accueil-section" class="feature-section">
                <h2>Bienvenue sur votre tableau de bord, Professeur !</h2>
                <p>Utilisez le menu latéral pour naviguer entre les différentes fonctionnalités.</p>
                <div class="accueil-cards-grid">
                    <div class="accueil-card" data-section="create-request">
                        <i class="fas fa-file-invoice-dollar icon"></i>
                        <h3>Créer une demande</h3>
                    </div>
                    <div class="accueil-card" data-section="view-status">
                        <i class="fas fa-list-alt icon"></i>
                        <h3>Consulter demandes</h3>
                    </div>
                    <div class="accueil-card" data-section="synthese">
                        <i class="fas fa-chart-bar icon"></i>
                        <h3>Voir synthèse</h3>
                    </div>
                </div>
            </section>

            <section id="create-request-section" class="feature-section hidden">
                <h2>Nouvelle Demande</h2>
                <p>Veuillez remplir le formulaire ci-dessous :</p>

                <form id="budget-request-form" method="POST" enctype="multipart/form-data">
                    <fieldset class="form-section">
                        <div class="form-group">
                            <label for="teacher-name">Nom de l'enseignant :</label>
                            <input type="text" id="teacher-name" name="teacherName" placeholder="Ex: M. Ndiaye" required>
                        </div>
                        <div class="form-group">
                            <label for="request-title">Intitulé de la demande <span class="required-star">*</span> :</label>
                            <input type="text" id="request-title" name="title" placeholder="Ex: Ordinateur portable" required>
                        </div>
                        <div class="form-group">
                            <label for="request-category">Catégorie <span class="required-star">*</span> :</label>
                            <select id="request-category" name="category" required>
                                <option value="">Sélectionnez une catégorie</option>
                                <option value="materiel_pedagogique">Matériel Pédagogique</option>
                                <option value="equipement_labo">Équipement de Laboratoire</option>
                                <option value="consommables">Consommables</option>
                                <option value="deplacement">Déplacements / Missions</option>
                                <option value="formation">Formation / Séminaires</option>
                                <option value="logiciels">Licences Logiciels</option>
                                <option value="services">Services Externes</option>
                                <option value="autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="request-description">Description <span class="required-star">*</span> :</label>
                            <textarea id="request-description" name="description" rows="6" placeholder="Ex: Besoin d'un ordinateur pour les cours magistraux." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="requested-amount">Montant total estimé (XOF) <span class="required-star">*</span> :</label>
                            <input type="number" id="requested-amount" name="amount" min="0" step="1" placeholder="Ex: 500000" required>
                        </div>
                    </fieldset>

                    <fieldset class="form-section">
                        <legend>Détails des Articles (Optionnel)</legend>
                        <p>Ajoutez des lignes pour détailler les différents articles ou services.</p>
                        <div id="items-container">
                            <!-- Les articles seront ajoutés ici dynamiquement -->
                        </div>
                        <button type="button" id="add-item-btn" class="btn btn-secondary small-btn">Ajouter un article</button>
                    </fieldset>

                    <fieldset class="form-section">
                        <legend>Pièces Jointes (Optionnel)</legend>
                        <div class="form-group">
                            <label for="attachments">Joindre des documents (devis, factures proforma, etc.) :</label>
                            <input type="file" id="attachments" name="attachments" multiple accept=".pdf,.doc,.docx,.jpg,.png">
                            <small>Formats acceptés : PDF, Word, Images. Taille maximale : 5MB par fichier.</small>
                        </div>
                    </fieldset>

                    <div class="form-buttons">
                        <button type="button" id="save-draft-btn" class="btn btn-secondary">Sauvegarder en brouillon</button>
                        <button type="submit" id="submit-request-btn" class="btn btn-primary">Soumettre la demande</button>
                    </div>
                </form>
            </section>

            <section id="view-status-section" class="feature-section hidden">
                <h2>Consulter le statut de mes demandes</h2>
                <p>Ici, vous pouvez consulter toutes vos demandes budgétaires et leur statut actuel.</p>
                <div class="table-responsive">
                    <table id="requests-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Titre</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Date de soumission</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les données seront chargées ici dynamiquement -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="synthese-section" class="feature-section hidden">
                <h2>Synthèse Budgétaire</h2>
                <p>Aperçu et statistiques de vos demandes budgétaires.</p>
                <div class="placeholder-content">
                    <div id="statistics-container">
                        <!-- Les statistiques seront affichées ici -->
                    </div>
                </div>
            </section>

            <section id="logout-section" class="feature-section hidden">
                <h2>Déconnexion</h2>
                <p>Êtes-vous sûr de vouloir vous déconnecter ?</p>
                <div class="form-buttons" style="justify-content: center;">
                    <button type="button" id="confirm-logout-btn" class="btn btn-primary">Confirmer la déconnexion</button>
                    <button type="button" class="btn btn-secondary cancel-logout-btn">Annuler</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Variables globales
        let itemCount = 0;

        // Fonction pour basculer entre les sections
        function showSection(sectionId) {
            // Cacher toutes les sections
            document.querySelectorAll('.feature-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Afficher la section demandée
            document.getElementById(sectionId + '-section').classList.remove('hidden');
            
            // Mettre à jour la navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
        }

        // Fonction pour ajouter un nouvel article
        function addItem() {
            itemCount++;
            const container = document.getElementById('items-container');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'item-row';
            itemDiv.innerHTML = `
                <div class="item-fields">
                    <div class="form-group">
                        <label for="item-name-${itemCount}">Nom de l'article :</label>
                        <input type="text" id="item-name-${itemCount}" name="itemName[]" placeholder="Ex: Ordinateur portable">
                    </div>
                    <div class="form-group">
                        <label for="item-quantity-${itemCount}">Quantité :</label>
                        <input type="number" id="item-quantity-${itemCount}" name="itemQuantity[]" min="1" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label for="item-price-${itemCount}">Prix unitaire (XOF) :</label>
                        <input type="number" id="item-price-${itemCount}" name="itemPrice[]" min="0" step="1" placeholder="250000">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger remove-item-btn" onclick="removeItem(this)">Supprimer</button>
                    </div>
                </div>
            `;
            container.appendChild(itemDiv);
        }

        // Fonction pour supprimer un article
        function removeItem(button) {
            button.closest('.item-row').remove();
        }

        // Fonction pour charger les demandes
        function loadRequests() {
            fetch('/consulter_demandes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const tbody = document.querySelector('#requests-table tbody');
                        tbody.innerHTML = '';
                        
                        data.demandes.forEach(demande => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${demande.id}</td>
                                <td>${demande.titre_demande}</td>
                                <td>${demande.montant_total.toLocaleString()} XOF</td>
                                <td><span class="status-badge status-${demande.statut}">${demande.statut_display}</span></td>
                                <td>${demande.date_creation}</td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="viewDetails(${demande.id})">Détails</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        alert('Erreur lors du chargement des demandes: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du chargement des demandes');
                });
        }

        // Fonction pour charger les statistiques
        function loadStatistics() {
            fetch('/obtenir_statistiques')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const container = document.getElementById('statistics-container');
                        const stats = data.statistiques;
                        
                        container.innerHTML = `
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <h3>Total des demandes</h3>
                                    <p class="stat-number">${stats.total_demandes}</p>
                                </div>
                                <div class="stat-card">
                                    <h3>Montant total</h3>
                                    <p class="stat-number">${stats.total_montant.toLocaleString()} XOF</p>
                                </div>
                            </div>
                        `;
                    } else {
                        alert('Erreur lors du chargement des statistiques: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du chargement des statistiques');
                });
        }

        // Fonction pour afficher les détails d'une demande
        function viewDetails(id) {
            alert('Détails de la demande ID: ' + id);
        }

        // Événements au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Navigation dans la sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section && section !== 'logout') {
                        showSection(section);
                        
                        // Charger les données spécifiques à chaque section
                        if (section === 'view-status') {
                            loadRequests();
                        } else if (section === 'synthese') {
                            loadStatistics();
                        }
                    }
                });
            });

            // Navigation dans les cartes d'accueil
            document.querySelectorAll('.accueil-card').forEach(card => {
                card.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    if (section) {
                        showSection(section);
                        
                        if (section === 'view-status') {
                            loadRequests();
                        } else if (section === 'synthese') {
                            loadStatistics();
                        }
                    }
                });
            });

            // Bouton d'ajout d'article
            document.getElementById('add-item-btn').addEventListener('click', addItem);

            // Gestion du formulaire de demande
            const form = document.getElementById('budget-request-form');
            const submitBtn = document.getElementById('submit-request-btn');
            const draftBtn = document.getElementById('save-draft-btn');

            // Soumission de la demande
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                
                fetch('/creer_demande', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        alert('Demande créée avec succès !');
                        form.reset();
                        document.getElementById('items-container').innerHTML = '';
                        itemCount = 0;
                        showSection('accueil');
                    } else {
                        alert('Erreur lors de la création de la demande');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la création de la demande');
                });
            });

            // Sauvegarde en brouillon
            draftBtn.addEventListener('click', function() {
                const formData = new FormData(form);
                formData.append('action', 'brouillon');
                
                fetch('/creer_demande', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        alert('Brouillon sauvegardé avec succès !');
                    } else {
                        alert('Erreur lors de la sauvegarde du brouillon');
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors de la sauvegarde du brouillon');
                });
            });

            // Bouton de déconnexion
            document.getElementById('confirm-logout-btn').addEventListener('click', function() {
                window.location.href = '/deconnexion';
            });

            // Annuler déconnexion
            document.querySelectorAll('.cancel-logout-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    showSection('accueil');
                });
            });
        });
    </script>
</body>
</html>